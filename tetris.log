pr bewege_steine
  farbe 7
  zeichne_stein (stein_gedreht (item :steintyp :steine) :steindreh) :steinx :steiny
  
  (wenn ((check_kollision (stein_gedreht (item :steintyp :steine) :steindreh) :steinx (:steiny+1))=0) 
    [setze "steiny :steiny+1
    ] [
      spielfeld_setze_stein
      zeilen_loeschen
      zeichne_spielfeldinhalt
      setze "steintyp ((zz 7)+1)
      setze "steinx 3
      setze "steiny 2
    ] )

  farbe :steintyp-1
  zeichne_stein (stein_gedreht (item :steintyp :steine) :steindreh) :steinx :steiny
ende

pr bewegedreh
  setze "st (stein_gedreht (item :steintyp :steine) (:steindreh+1)) 
  wenn ((check_kollision :st :steinx :steiny)=0) [  
    farbe 7
    zeichne_stein (stein_gedreht (item :steintyp :steine) :steindreh) :steinx :steiny
    setze "steindreh (wenn (:steindreh>2) [0] [:steindreh + 1])
    farbe :steintyp-1
    zeichne_stein (stein_gedreht (item :steintyp :steine) :steindreh) :steinx :steiny
  ]
ende

pr bewegerichtung :richtungx :richtungy
;bei -1 und 5 anfangen rand zu checken
;kleiner -3 und größer 7 sollte nicht möglich sein
  setze "st (stein_gedreht (item :steintyp :steine) :steindreh)
  (wenn (und (und (:steinx+:richtungx> -4)(:steinx+:richtungx< (:spielfeldbreite-2)))((check_kollision :st (:steinx+:richtungx) (:steiny+:richtungy))=0)) [
    farbe 7
    zeichne_stein (stein_gedreht (item :steintyp :steine) :steindreh) :steinx :steiny
    setze "steinx :steinx + :richtungx
    setze "steiny :steiny + :richtungy
    farbe :steintyp-1
    zeichne_stein (stein_gedreht (item :steintyp :steine) :steindreh) :steinx :steiny
  ])
ende

pr check_kollision :stein :neux :neuy

  for [ix 1 4 1] [
       (wenn (und((spielfeld_wert :neux+:ix+1 :neuy+2)>0)((item (3*4+:ix) :stein))=1) [Rückgabe 1])
       (wenn (und((spielfeld_wert :neux+:ix+1 :neuy+1)>0)((item (2*4+:ix) :stein))=1) [Rückgabe 1])
       (wenn (und((spielfeld_wert :neux+:ix+1 :neuy  )>0)((item (1*4+:ix) :stein))=1) [Rückgabe 1])
       (wenn (und((spielfeld_wert :neux+:ix+1 :neuy-1)>0)((item (0*4+:ix) :stein))=1) [Rückgabe 1])

    ]

  Rückgabe 0
ende 

pr definiere_steine
  setze "steine [[0 0 0 0 
                  0 1 1 0 
                  0 1 1 0 
                  0 0 0 0]
                 [0 0 0 0 
                  0 0 1 0 
                  0 1 1 1 
                  0 0 0 0]
                 [0 0 0 0 
                  0 1 1 0 
                  0 0 1 1 
                  0 0 0 0]
                 [0 0 0 0 
                  0 1 1 0 
                  1 1 0 0 
                  0 0 0 0]
                 [0 0 0 0 
                  0 1 0 0 
                  0 1 1 1 
                  0 0 0 0]
                 [0 0 0 0 
                  0 0 1 0 
                  1 1 1 0 
                  0 0 0 0]
                 [0 0 0 0 
                  0 0 0 0 
                  1 1 1 1 
                  0 0 0 0]
                ]
ende

pr spielfeld_setze_stein
  setze "zwi (stein_gedreht (item :steintyp :steine) :steindreh) 
  for [iy 1 4 1] [
    for [ix 1 4 1] [
      setze "wert (item ((:iy-1)*4+:ix) :zwi)
      (wenn (:wert>0) [spielfeld_wert_setzen (:steinx+:ix+1) (:steiny+:iy-2) (:steintyp)])
    ]
  ]
ende

pr spielfeld_wert :x :y
  (wenn (:y<1) [Rückgabe 0])
  (wenn (:y>25) [Rückgabe 1])
  (wenn (OR (:x<1) (:x>:spielfeldbreite)) [Rückgabe 1])
  Rückgabe (item ((:y-1)*:spielfeldbreite+:x) :spielfeld)
ende

pr spielfeld_wert_setzen :x :y :wert
  (wenn (:y<1) [rk])
  (wenn (:y>25) [rk])
  (wenn (OR (:x<1) (:x>:spielfeldbreite)) [rk])
  setitem ((:y-1)*:spielfeldbreite+:x) :spielfeld :wert
ende

pr spielschleife
  do.while [bewege_steine warte 30] [:stoppen=0]
ende

pr stein_gedreht :stein :drehung
  (wenn (:drehung=0) [Rückgabe :stein][
  setze "zwi :stein 
  wh :drehung [
    setze "stein_neu [] 
  for [iy 1 4 1] [
    for [ix 1 4 1] [
      queue "stein_neu (item ((4-:ix)*4+:iy) :zwi) 
    ]
    ]
  setze "zwi :stein_neu
  ]  
  Rückgabe  :stein_neu
  ])
ende

pr t
  bild
  tetris
ende

pr tasteneingabe
  wenn :stoppen=1 [showturtle halt] 
    keyboardon [tasteneingabe] setfocus [MSWLogo SCREEN] 
    if keyboardvalue = ASCII "a [bewegerichtung -1 0]  
    if keyboardvalue = ASCII "d [bewegerichtung 1 0] 
    if keyboardvalue = ASCII "s [bewegerichtung 0 1] 
    if keyboardvalue = ASCII "w [bewegedreh]
    if keyboardvalue = ASCII "q [setze "stoppen 1]
ende

pr tetris
  setze "spielfeldbreite 10

  farbe 0
  hideturtle
  sh aufxy -300 100 re 90 sa
  label [a:links  d:rechts] 
  sh aufxy -300 80 sa
  label [q:ende  w:dreh] 
  sh li 90 aufxy 0 0 sa
  setze "spielfeld (ARRAY (25*:spielfeldbreite) 1)
  for [i 1 (25*:spielfeldbreite) 1] [setitem :i :spielfeld 0]
  
  definiere_steine
  setze "steinx 3
  setze "steiny 2
  setze "steindreh 0
  setze "steintyp 6
  setze "stoppen 0
  zeichne_umgebung
  zeichne_spielfeldinhalt
  tasteneingabe
  spielschleife
ende

pr zeichne_spielfeldinhalt
  sh
  aufxy (-1*10) 15*10
  sa 
  for [iy 1 25 1] [
    sh rw 10 sa
    for [ix 1 :spielfeldbreite 1] [
      sh re 90 vw 10 li 90 sa
      setze "steinfarbe (item ((:iy-1)*:spielfeldbreite + :ix) :spielfeld) 
      füllfarbe (wenn (:steinfarbe=0) [7][:steinfarbe - 1])
      bb 9 9
    ]
    sh re 90 rw (10*:spielfeldbreite) li 90 sa
  ]
  sh vw 250 sa
ende

pr zeichne_stein :stein :posx :posy
  sh
  aufxy :posx*10 (25-:posy-4-4)*10
  sa 
  for [iy 1 4 1] [
    sh rw 10 sa
    for [ix 1 4 1] [
      sh re 90 vw 10 li 90 sa
      
      wenn ((item ((:iy-1)*4 + :ix) :stein) = 1) [wh 4 [vw 10 re 90]] 
    ]
    sh re 90 rw 40 li 90 sa
  ]
  sh vw 40 sa
ende

pr zeichne_umgebung
  sh rw 101 li 90 vw 1 re 90 sa
  wh 2 [vw 252 re 90 vw ((10*:spielfeldbreite)+2) re 90 ]
  sh vw 1 re 90 vw 1 li 90 sa

ende

pr zeilen_loeschen
  wh 4 [
  for [iy 1 25 1] [
    setze "anz 0
    for [ix 1 :spielfeldbreite 1] [
      (wenn ((spielfeld_wert :ix :iy) >0) [setze "anz :anz+1])
    ]
    (wenn (:anz >= :spielfeldbreite) [
      for [iiy (:iy-1) 1 -1] [
        for [iix 1 :spielfeldbreite 1] [
          spielfeld_wert_setzen :iix (:iiy+1) (spielfeld_wert :iix :iiy)
        ]
      ]
    ])
  ]
  ]
ende

setze "anz 13
setze "spielfeld {0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 6 0 4 0 0 0 0 0 0 7 0 0 0 0 0 0 0 0 0 0 6 0 4 4 0 0 0 0 0 7 0 0 0 0 0 0 0 6 1 1 6 6 6 4 2 0 0 2 0 7 5 0 0 1 1}
setze "spielfeldbreite 20
setze "st [0 1 0 0 0 1 1 0 0 0 1 0 0 0 0 0]
setze "stein_neu [0 1 0 0 0 1 1 0 0 0 1 0 0 0 0 0]
setze "steindreh 1
setze "steine [[0 0 0 0 0 1 1 0 0 1 1 0 0 0 0 0] [0 0 0 0 0 0 1 0 0 1 1 1 0 0 0 0] [0 0 0 0 0 1 1 0 0 0 1 1 0 0 0 0] [0 0 0 0 0 1 1 0 1 1 0 0 0 0 0 0] [0 0 0 0 0 1 0 0 0 1 1 1 0 0 0 0] [0 0 0 0 0 0 1 0 1 1 1 0 0 0 0 0] [0 0 0 0 0 0 0 0 1 1 1 1 0 0 0 0]]
setze "steinfarbe 1
setze "steintyp 4
setze "steinx 3
setze "steiny 3
setze "stoppen 1
setze "wert 0
setze "zwi [0 1 0 0 0 1 1 0 0 0 1 0 0 0 0 0]
